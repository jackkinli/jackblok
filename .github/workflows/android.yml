name: Build Android APK (Godot 4.4.1 + Gradle)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  android:
    runs-on: ubuntu-latest

    container:
      image: barichello/godot-ci:4.4.1

    env:
      HOME: /root
      ANDROID_SDK_ROOT: /usr/lib/android-sdk
      ANDROID_HOME: /usr/lib/android-sdk
      JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64

      EXPORT_PRESET: "Android"
      OUT_DIR: "builds/android"
      OUT_APK: "builds/android/Blox3D-debug.apk"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install JDK 17 + tools (inside container)
        shell: bash
        run: |
          set -euxo pipefail
          apt-get update
          apt-get install -y openjdk-17-jdk unzip wget
          java -version
          test -x "$JAVA_HOME/bin/jarsigner"

      - name: Install Android SDK packages (API 35 + build-tools 35)
        shell: bash
        run: |
          set -euxo pipefail
          command -v sdkmanager

          yes | sdkmanager --licenses || true

          sdkmanager --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "cmdline-tools;latest" \
            "platforms;android-35" \
            "build-tools;35.0.0" \
            "cmake;3.10.2.4988404" \
            "ndk;28.1.13356709"

          test -x "$ANDROID_SDK_ROOT/build-tools/35.0.0/apksigner"
          test -x "$ANDROID_SDK_ROOT/build-tools/35.0.0/zipalign"

      - name: Create debug keystore (and commit into workspace for export)
        shell: bash
        run: |
          set -euxo pipefail
          keytool -genkeypair -v \
            -keystore debug.keystore \
            -storepass android \
            -alias androiddebugkey \
            -keypass android \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          # Godot preset above references res://debug.keystore
          test -f "$GITHUB_WORKSPACE/debug.keystore"

      - name: Configure Godot Editor Settings for Android export
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p "$HOME/.config/godot"
          for SETTINGS in "$HOME/.config/godot/editor_settings-4.tres" "$HOME/.config/godot/editor_settings-4.4.tres"; do
            printf '[gd_resource type="EditorSettings" format=3]\n[resource]\n' > "$SETTINGS"
            echo "export/android/java_sdk_path = \"$JAVA_HOME\"" >> "$SETTINGS"
            echo "export/android/android_sdk_path = \"$ANDROID_SDK_ROOT\"" >> "$SETTINGS"
            echo "export/android/adb = \"$ANDROID_SDK_ROOT/platform-tools/adb\"" >> "$SETTINGS"
            echo "export/android/jarsigner = \"$JAVA_HOME/bin/jarsigner\"" >> "$SETTINGS"
          done

      - name: Export APK (debug)
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p "$OUT_DIR"

          set +e
          godot --headless --path "$GITHUB_WORKSPACE" --verbose \
            --export-debug "$EXPORT_PRESET" "$OUT_APK" 2>&1 | tee export.log
          status=${PIPESTATUS[0]}
          set -e

          echo "----- LAST 200 LINES export.log -----"
          tail -n 200 export.log || true
          echo "-------------------------------------"

          exit $status

      - name: Upload export.log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: export-log
          path: export.log

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: Blox3D-debug-apk
          path: builds/android/Blox3D-debug.apk
