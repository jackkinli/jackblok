name: Android (Debug APK)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      GODOT_VERSION: "4.4.1"
      EXPORT_PRESET: "Android"
      OUT_DIR: "builds/android"
      OUT_APK: "builds/android/Blox3D-debug.apk"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install dependencies
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y unzip wget ca-certificates

      - name: Install Godot headless + export templates
        shell: bash
        run: |
          set -euxo pipefail

          GODOT_ZIP="Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip"
          TEMPLATES_TPZ="Godot_v${GODOT_VERSION}-stable_export_templates.tpz"

          mkdir -p .cache/godot
          cd .cache/godot

          # Download from GitHub releases (more reliable than SourceForge/Tuxfamily)
          wget -O "$GODOT_ZIP" \
            "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable/${GODOT_ZIP}"

          wget -O "$TEMPLATES_TPZ" \
            "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable/${TEMPLATES_TPZ}"

          cd ../..

          mkdir -p "$HOME/.local/bin"
          unzip -o ".cache/godot/$GODOT_ZIP" -d "$HOME/.local/bin"
          chmod +x "$HOME/.local/bin/Godot_v${GODOT_VERSION}-stable_linux.x86_64"
          ln -sf "$HOME/.local/bin/Godot_v${GODOT_VERSION}-stable_linux.x86_64" "$HOME/.local/bin/godot"

          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          # Install export templates
          mkdir -p "$HOME/.local/share/godot/export_templates"
          mkdir -p "$HOME/.local/share/godot/export_templates/${GODOT_VERSION}.stable"

          unzip -o ".cache/godot/$TEMPLATES_TPZ" -d ".cache/godot/templates"
          # tpz contains a "templates" directory
          rsync -a ".cache/godot/templates/templates/" \
            "$HOME/.local/share/godot/export_templates/${GODOT_VERSION}.stable/"

          echo "Godot version:"
          godot --version
          echo "Templates installed:"
          ls -la "$HOME/.local/share/godot/export_templates/${GODOT_VERSION}.stable" | head -
