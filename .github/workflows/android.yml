name: Android (Debug APK)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      GODOT_VERSION: "4.4.1"
      EXPORT_PRESET: "Android"
      OUT_DIR: "builds/android"
      OUT_APK: "builds/android/Blox3D-debug.apk"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install dependencies
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y unzip wget ca-certificates

      - name: Install Godot headless + export templates
        shell: bash
        run: |
          set -euxo pipefail

          GODOT_ZIP="Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip"
          TEMPLATES_TPZ="Godot_v${GODOT_VERSION}-stable_export_templates.tpz"

          mkdir -p .cache/godot
          cd .cache/godot

          # Download from GitHub releases (more reliable than SourceForge/Tuxfamily)
          wget -O "$GODOT_ZIP" \
            "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable/${GODOT_ZIP}"

          wget -O "$TEMPLATES_TPZ" \
            "https://github.com/godotengine/godot/releases/download/${GODOT_VERSION}-stable/${TEMPLATES_TPZ}"

          cd ../..

          mkdir -p "$HOME/.local/bin"
          unzip -o ".cache/godot/$GODOT_ZIP" -d "$HOME/.local/bin"
          chmod +x "$HOME/.local/bin/Godot_v${GODOT_VERSION}-stable_linux.x86_64"
          ln -sf "$HOME/.local/bin/Godot_v${GODOT_VERSION}-stable_linux.x86_64" "$HOME/.local/bin/godot"

          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

          # Install export templates
          mkdir -p "$HOME/.local/share/godot/export_templates"
          mkdir -p "$HOME/.local/share/godot/export_templates/${GODOT_VERSION}.stable"

          unzip -o ".cache/godot/$TEMPLATES_TPZ" -d ".cache/godot/templates"
          # tpz contains a "templates" directory
          rsync -a ".cache/godot/templates/templates/" \
            "$HOME/.local/share/godot/export_templates/${GODOT_VERSION}.stable/"

          echo "Godot version:"
          godot --version
          echo "Templates installed:"
          ls -la "$HOME/.local/share/godot/export_templates/${GODOT_VERSION}.stable" | head -n 50

      - name: Locate Android SDK + sdkmanager and install packages
        shell: bash
        run: |
          set -euxo pipefail

          # You already have an SDK at this location in your logs
          SDKROOT="/usr/local/lib/android/sdk"
          if [ ! -d "$SDKROOT" ]; then
            SDKROOT="/usr/lib/android-sdk"
          fi
          test -d "$SDKROOT"

          echo "ANDROID_SDK_ROOT=$SDKROOT" >> "$GITHUB_ENV"
          echo "ANDROID_HOME=$SDKROOT" >> "$GITHUB_ENV"

          # Find sdkmanager (not always on PATH)
          SDKMANAGER=""
          if [ -x "$SDKROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMANAGER="$SDKROOT/cmdline-tools/latest/bin/sdkmanager"
          elif [ -x "$SDKROOT/cmdline-tools/bin/sdkmanager" ]; then
            SDKMANAGER="$SDKROOT/cmdline-tools/bin/sdkmanager"
          else
            SDKMANAGER="$(find "$SDKROOT/cmdline-tools" -type f -name sdkmanager -perm -111 | head -n 1 || true)"
          fi

          if [ -z "$SDKMANAGER" ]; then
            echo "sdkmanager not found under $SDKROOT/cmdline-tools"
            find "$SDKROOT/cmdline-tools" -maxdepth 4 -type f -name sdkmanager || true
            exit 1
          fi

          echo "Using sdkmanager at: $SDKMANAGER"
          yes | "$SDKMANAGER" --sdk_root="$SDKROOT" --licenses || true

          "$SDKMANAGER" --sdk_root="$SDKROOT" \
            "platform-tools" \
            "platforms;android-35" \
            "build-tools;35.0.0"

          test -x "$SDKROOT/build-tools/35.0.0/apksigner"
          test -x "$SDKROOT/build-tools/35.0.0/zipalign"
          test -x "$SDKROOT/platform-tools/adb"

      - name: Create debug.keystore + set Godot debug keystore env vars (all-or-nothing)
        shell: bash
        run: |
          set -euxo pipefail

          KEYSTORE_PATH="$GITHUB_WORKSPACE/debug.keystore"
          rm -f "$KEYSTORE_PATH"

          keytool -genkeypair \
            -keystore "$KEYSTORE_PATH" \
            -storepass android \
            -alias androiddebugkey \
            -keypass android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          test -f "$KEYSTORE_PATH"

          echo "GODOT_ANDROID_KEYSTORE_DEBUG_PATH=$KEYSTORE_PATH" >> "$GITHUB_ENV"
          echo "GODOT_ANDROID_KEYSTORE_DEBUG_USER=androiddebugkey" >> "$GITHUB_ENV"
          echo "GODOT_ANDROID_KEYSTORE_DEBUG_PASSWORD=android" >> "$GITHUB_ENV"

      - name: Configure Godot Editor Settings for Android export
        shell: bash
        run: |
          set -euxo pipefail
          source "$GITHUB_ENV"

          mkdir -p "$HOME/.config/godot"

          # Godot 4.4.x may read editor_settings-4.4.tres; write both.
          for SETTINGS in "$HOME/.config/godot/editor_settings-4.tres" "$HOME/.config/godot/editor_settings-4.4.tres"; do
            printf '[gd_resource type="EditorSettings" format=3]\n[resource]\n' > "$SETTINGS"
            echo "export/android/java_sdk_path = \"$JAVA_HOME\"" >> "$SETTINGS"
            echo "export/android/android_sdk_path = \"$ANDROID_SDK_ROOT\"" >> "$SETTINGS"
            echo "export/android/adb = \"$ANDROID_SDK_ROOT/platform-tools/adb\"" >> "$SETTINGS"
            echo "export/android/jarsigner = \"$JAVA_HOME/bin/jarsigner\"" >> "$SETTINGS"
          done

      - name: Export Android Debug APK
        shell: bash
        run: |
          set -euxo pipefail
          mkdir -p "$OUT_DIR"

          echo "JAVA_HOME=$JAVA_HOME"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          echo "GODOT_ANDROID_KEYSTORE_DEBUG_PATH=$GODOT_ANDROID_KEYSTORE_DEBUG_PATH"
          godot --version

          set +e
          godot --headless --path "$GITHUB_WORKSPACE" --verbose \
            --export-debug "$EXPORT_PRESET" "$OUT_APK" 2>&1 | tee export.log
          status=${PIPESTATUS[0]}
          set -e

          echo "----- LAST 200 LINES export.log -----"
          tail -n 200 export.log || true
          echo "-------------------------------------"

          if [ "$status" -eq 0 ]; then
            test -f "$OUT_APK"
            ls -lh "$OUT_APK"
          fi

          exit "$status"

      - name: Upload APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: Blox3D-debug-apk
          path: builds/android/Blox3D-debug.apk

      - name: Upload export.log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: export-log
          path: export.log
