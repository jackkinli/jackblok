name: Android (Debug APK)

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Locate Android SDK + sdkmanager and install packages
        shell: bash
        run: |
          set -euxo pipefail

          # Prefer the SDK you actually have (your log shows this exists)
          SDKROOT="/usr/local/lib/android/sdk"
          if [ ! -d "$SDKROOT" ]; then
            SDKROOT="/usr/lib/android-sdk"
          fi
          test -d "$SDKROOT"

          echo "ANDROID_SDK_ROOT=$SDKROOT" >> "$GITHUB_ENV"
          echo "ANDROID_HOME=$SDKROOT" >> "$GITHUB_ENV"

          # Find sdkmanager (not always on PATH)
          SDKMANAGER=""
          if [ -x "$SDKROOT/cmdline-tools/latest/bin/sdkmanager" ]; then
            SDKMANAGER="$SDKROOT/cmdline-tools/latest/bin/sdkmanager"
          elif [ -x "$SDKROOT/cmdline-tools/bin/sdkmanager" ]; then
            SDKMANAGER="$SDKROOT/cmdline-tools/bin/sdkmanager"
          else
            # Search a little deeper for unusual layouts
            SDKMANAGER="$(find "$SDKROOT/cmdline-tools" -type f -name sdkmanager -perm -111 | head -n 1 || true)"
          fi

          if [ -z "$SDKMANAGER" ]; then
            echo "sdkmanager not found under $SDKROOT/cmdline-tools"
            find "$SDKROOT/cmdline-tools" -maxdepth 3 -type f -name sdkmanager || true
            exit 1
          fi

          echo "Using sdkmanager at: $SDKMANAGER"
          echo "SDKMANAGER=$SDKMANAGER" >> "$GITHUB_ENV"

          # Accept licenses + install what Godot needs
          yes | "$SDKMANAGER" --sdk_root="$SDKROOT" --licenses || true

          "$SDKMANAGER" --sdk_root="$SDKROOT" \
            "platform-tools" \
            "platforms;android-35" \
            "build-tools;35.0.0"

          # Hard verify build tools we need exist
          test -x "$SDKROOT/build-tools/35.0.0/apksigner"
          test -x "$SDKROOT/build-tools/35.0.0/zipalign"
          test -x "$SDKROOT/platform-tools/adb"

      - name: Create debug.keystore + set Godot debug keystore env vars (all-or-nothing)
        shell: bash
        run: |
          set -euxo pipefail

          KEYSTORE_PATH="$GITHUB_WORKSPACE/debug.keystore"
          rm -f "$KEYSTORE_PATH"

          keytool -genkeypair \
            -keystore "$KEYSTORE_PATH" \
            -storepass android \
            -alias androiddebugkey \
            -keypass android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"

          test -f "$KEYSTORE_PATH"

          # Force ALL THREE so Godot never hits the partial-config error
          echo "GODOT_ANDROID_KEYSTORE_DEBUG_PATH=$KEYSTORE_PATH" >> "$GITHUB_ENV"
          echo "GODOT_ANDROID_KEYSTORE_DEBUG_USER=androiddebugkey" >> "$GITHUB_ENV"
          echo "GODOT_ANDROID_KEYSTORE_DEBUG_PASSWORD=android" >> "$GITHUB_ENV"

      - name: Configure Godot Editor Settings for Android export (no partial keystore fields)
        shell: bash
        run: |
          set -euxo pipefail
          source "$GITHUB_ENV"

          mkdir -p "$HOME/.config/godot"

          # Godot 4.4.x reads
